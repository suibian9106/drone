# 无人机组装

本指南参考于浙大Fast-Lab的开源项目：

[浙大Fast-Lab从零开始组装无人机](https://www.bilibili.com/video/BV1WZ4y167me?spm_id_from=333.788.videopod.episodes&vd_source=954f7b6885820d4523a9f4669d618ba2)

[github开源项目](https://github.com/ZJU-FAST-Lab/Fast-Drone-250)

## 主要硬件说明

* 硬件
    * 机架、`电调`、电机、`飞控`、DC供电线、飞控连接线、接收机、`遥控器`、稳压模块、碳纤维板、电池、桨叶等

### 1. 飞控

飞控又称飞行控制器，用于根据各种信息解算电机推力，从而控制无人机运动。

* 主微控制器（MCU）
    * 作用：运行PX4固件，执行传感器数据融合、控制算法、模式切换、任务管理等核心逻辑。

* 飞控一般内置了IMU，气压计，磁罗盘等
    * IMU惯性测量单元是指测量物体三轴姿态角（俯仰角、偏航角、翻滚角）以及加速度的装置，用于无人机等设备中提供精确的姿态解算数据。
    * 气压计用来输出无人机的高度
    * 磁罗盘用来获取无人机的朝向

* px4固件
    * PX4 固件是一款专为无人机及无人载具设计的开源飞行控制软件，其核心作用是将传感器数据转化为执行器指令，实现载具的稳定飞行、自主导航与任务执行，相当于操作系统。

* 选取的型号
    * `pixhawk4` 搭配官方1.11.0版本飞控固件：`px4_fmu-v5_default.px4`
    * `pixhawk4 2.4.8` 搭配官方1.11.0版本飞控固件：`px4_fmu-v3_default.px4`

* pixhawk4接口图
    <img src="images\飞控接口图.jpg" alt="飞控接口" />
    * 当前需要使用的接口：
        * POWER1/POWER2：电源接口，连接稳压模块输出的飞控电源接口
        * DSM/SBUS RC：接收机接口，接收DSM/SBUS类别接收机的信号输入
        * FMU PWM OUT：电调信号输出接口，将电机的控制信息传给电调
        * Micro-USB Port: USB接口，用于飞控与电脑连接，进行飞控设置
    * MAIN OUT：在 Pixhawk 系列飞控中，MAIN OUT 端口一般与 IO 板相连，其 PWM 信号（Pulse Width Modulation，简称脉宽调制）会先传输到 IO 板，再通过 IO 板控制外部设备。MAIN OUT 端口支持 PWM 信号，部分飞控也支持 D-shot 或 One-shot 协议。IO模块具有单独处理输入输出信号的功能，如PWM信号输出、遥控信号输入

    * FMU OUT：FMU OUT 端口直接连接到 FMU（Flight Management Unit，飞行管理单元），FMU 会将控制信号发送到 FMU OUT 端口，从而控制相应的外部设备。支持 PWM 信号，同样支持 D-shot 或 One-shot 协议，可以为需要低延迟控制的设备提供更好的性能。

### 2. 电调
电调全称电子调速器（Electronic Speed Control，简称ESC）。电调可以理解为电机的驱动，功能就是根据输入的控制信号来控制电机的电流，从而控制电机的转速。

* 电调和飞控之间信号传输通常采用数字协议DSHOT协议
    * 11位油门信号：共有2048个不同的值。0保留为上锁命令，1-47被保留为特殊命令。剩下的48-2047（共2000步）用于实际的油门值
    * 1位回传请求：如果设置了这一位，那么遥测数据将通过另外一根专线（电调回传线）单独发回飞控
    * 4位CRC(Cyclic Redundancy Checksum，循环冗余校验)：检验数据的有效性（包括油门数据以及回传请求位）

## 详细组装、焊接、设置过程

详细过程参考视频[浙大Fast-Lab从零开始组装无人机](https://www.bilibili.com/video/BV1WZ4y167me?spm_id_from=333.788.videopod.episodes&vd_source=954f7b6885820d4523a9f4669d618ba2)


## 飞控设置补充说明

### 1
```
在飞控的sd卡的根目录下创建`/etc/extras.txt`，写入
  mavlink stream -d /dev/ttyACM0 -s ATTITUDE_QUATERNION -r 200
  mavlink stream -d /dev/ttyACM0 -s HIGHRES_IMU -r 200
以提高imu发布频率
```

-d /dev/ttyACM0：指定 MAVLink 输出设备
（常见飞控 USB 虚拟串口，Linux 下为 ttyACM*，Windows 为 COM*）

-s HIGHRES_IMU：选择传感器消息类型

-r 200：设置发布频率为 200Hz

* HIGHRES_IMU：原始加速度计/陀螺仪/温度数据，传感器级分析，振动检测
* ATTITUDE_QUATERNION：四元数姿态 + 角速度，精准姿态控制

这配置主要是提高飞控将 IMU 数据发布给地面站或者其他与飞控通过 MAVLink 协议通信的设备的频率。通过提高数据传输频率，地面站可以更及时地获取无人机的 IMU 数据，从而能够更精确地监控无人机的状态

### 2
```
修改机架类型为 `Generic 250 Racer`，代指250mm轴距机型。如果是其他尺寸的机架，请根据实际轴距选择机架类型
```

轴距：轴距是指对角两个旋翼轴之间的距离，它决定了无人机的尺寸大小和稳定性。一般来说，轴距越大，无人机的稳定性越好，但机动性会相对降低，且对螺旋桨的最大直径有要求，轴距越大可使用的螺旋桨直径也越大，提供的拉力也越大

### 3
```
修改`dshot_config`为dshot600

修改`CBRK_SUPPLY_CHK`为894281

修改`CBRK_USB_CHK`为197848

修改`CBRK_IO_SAFETY`为22027

修改`SER_TEL1_BAUD`为921600

修改`SYS_USE_IO`为0（搜索不到则不用管）
```

* DSHOT_CONFIG dshot600：设置电调协议为DShot600，提升电机响应速度，降低延迟
* CBRK_SUPPLY_CHK 894281：禁用电源检查，绕过电池检测（无电池或特殊供电场景）
* CBRK_USB_CHK 197848：禁用USB连接检查，允许USB连接时解锁电机（调试场景）
* CBRK_IO_SAFETY 22027：禁用安全开关，跳过物理安全开关触发流程
* SER_TEL1_BAUD	921600：设置TELEM1串口波特率，提高数传通信带宽，TELEM1串口是一个非常重要的通信接口，主要用于数据传输和通信
* SYS_USE_IO 0：禁用IO协处理器，解决协处理器兼容性问题，使用FMU OUT作为电调输出端口

### 飞行模式
遥控器进行通道绑定：

  五通——switch-E

  六通——switch-D

  七通——switch-F

---

通道 1：横滚(Roll) - 控制飞机左右倾斜

通道 2：俯仰(Pitch) - 控制飞机机头上下俯仰

通道 3：油门(Throttle) - 控制电机总功率（在多旋翼上直接控制推力，在固定翼上控制发动机转速）

通道 4：偏航(Yaw) - 控制飞机绕垂直轴旋转（方向舵）

通道 5：飞行模式切换 - 通常是一个 3 位或 6 位开关，用于在主要的飞行模式之间切换（例如：自稳模式、定高模式、位置模式、返航模式、任务模式等）

通道 6：辅助 1 - 用于可配置的辅助功能（Offboard模式切换，offboard模式是一种飞行模式，允许用户通过外部控制源（如地面控制站或机载电脑系统）来控制飞行器）

通道 7：辅助 2 - 用于可配置的辅助功能（急停）

通道 8：辅助 3 - 用于可配置的辅助功能（例如：触发航点任务、启用地理围栏覆盖等）

---

<img src="images\无人机飞行模式.png" alt="飞行模式设置" />

```
通过 QGroundControl (QGC) 将遥控器通道 5（通常是飞行模式切换开关）的 位置 1、位置 4、位置 6 都设置为 Stabilized (自稳模式)
```

飞行模式切换开关的三个特定档位对应同一个模式： 无论将通道 5 的拨到第 1 、4 、6 档，PX4 飞控都将进入 Stabilized 模式

当拨动 SWE 开关（三个挡位）时，它会在通道5上输出一个特定的 PWM 信号值（例如在 1000μs 到 2000μs 之间）

PX4/QGC 的划分： PX4/QGC 将这个连续的PWM值范围（1000μs - 2000μs）均等划分为6个区间，每个区间对应一个逻辑位置（1-6），
SWE 开关的最低档、中间档、最高档分别对应逻辑位置1、4、6

**Stabilized 模式的行为：**
* 核心功能： 这是 PX4 中最基础、最核心的姿态稳定模式

* 滚转/俯仰控制： 当松开摇杆时，飞控会自动将飞机恢复到水平姿态（横滚角和俯仰角归零），并保持这个水平姿态。通过摇杆控制的是飞机的倾斜角度和旋转速率

* 偏航控制： 偏航摇杆控制飞机绕垂直轴的旋转速率。松开摇杆时，飞控会阻止飞机继续旋转（角速度归零），但不会自动将机头指向某个特定的方向（即不控制偏航角）

* 高度/位置控制： Stabilized 模式不控制高度和水平位置

* 油门控制： 在多旋翼上，油门摇杆直接控制总推力（向上或向下）。在固定翼上，油门摇杆控制发动机/电机转速

* 高度： 油门需要持续手动调节才能维持高度（多旋翼）或爬升/下降（固定翼）。松开油门杆，多旋翼会下落（如果推力小于重力），固定翼会下降

* 位置： 如果有风，飞机会被风吹走。飞控不会自动抵抗风或保持在一个固定的水平位置上。需要手动打杆来抵消风的影响

# QGC(QGroundControl)

QGC（QGroundControl）是一款开源的地面控制站软件，主要用于无人机的飞控设置、飞行控制、任务规划与实时监控。

## QGC 功能
---

### **1. 飞行控制与任务规划**
- **航线规划**：用户可在地图上直观设置航点、巡逻路径、区域限制，并定义每个航点的高度、速度及任务类型（如拍照、悬停）。
- **自动化任务**：支持航点任务模式，无人机按预设路径自主飞行，执行拍照、环绕等操作。例如，环绕模式（Orbit Mode）可绕目标点飞行，并通过遥控器动态调整半径、高度与方向。
- **多模式飞行**：提供定点悬停、航线跟踪、自动返航（RTL）等多种飞行模式，适应不同场景需求。

---

### **2. 状态监控与安全保障**
- **实时数据反馈**：显示无人机的飞行高度、速度、电池电量、GPS信号强度及传感器状态，帮助操作员实时掌握飞行状况。
- **飞行前检查**：执行严格的传感器质量与估计器检查（如IMU加速度/陀螺仪偏差、指南针一致性），若未通过则阻止解锁，确保飞行安全。
- **故障保护机制**：支持设置集结点（Rally Point）作为紧急降落点，并在通信中断时自动触发返航或悬停。

---

### **3. 数据处理与协同**
- **实时影像传输**：接收无人机摄像头（含红外热成像）的实时视频流，用于边境巡逻、资产检查等场景，支持数字变焦与多视角切换。
- **数据记录与分析**：自动保存遥测日志与媒体文件（可加密），支持后续回放与分析，用于优化任务策略。
- **多机协同**：支持同时连接多台无人机，共享实时数据与任务状态，提升大规模监测效率（如边境巡逻）。


视频[浙大Fast-Lab从零开始组装无人机](https://www.bilibili.com/video/BV1WZ4y167me?spm_id_from=333.788.videopod.episodes&vd_source=954f7b6885820d4523a9f4669d618ba2)演示了使用QGC对飞控进行设置的操作。

## QGC和飞控通信

QGroundControl（QGC）与PX4飞控的通信主要通过**MAVLink协议**实现，支持多种物理连接方式。以下是主要通信方式及配置步骤：

---

### **1. USB直连**
- **操作步骤**：
  1. 使用USB线连接PX4飞控与运行QGC的电脑。
  2. 首次连接时，QGC可能自动提示固件更新，需重新插拔USB完成烧录。
  3. 连接成功后，QGC主界面显示飞控状态（如电池、GPS、传感器数据）。
- **适用场景**：地面调试、参数校准、固件烧录。
- **注意事项**：避免在安装螺旋桨时使用USB连接，防止误启动。

---

### **2. 数传电台（无线连接）**
#### **SiK遥测无线电（需无线电硬件）**
- **配置步骤**：
  1. **硬件配对**：将两电台分别连接飞控的`TELEM1`或`TELEM2`串口与电脑USB口，确保波特率一致（通常57600）。
  2. **飞控参数设置**：
     - 在QGC中设置`MAV_1_CONFIG`为`TELEM1`或`TELEM2`（对应连接串口）。
     - 调整`SER_TEL1_BAUD`或`SER_TEL2_BAUD`电台波特率并重启飞控。
  3. **QGC连接**：选择`Serial Port`，识别电台设备（如`/dev/ttyUSB0`）并连接。
- **特点**：中长距离通信（1-5公里），适合野外飞行。

#### **WiFi数传（需WIFI模块）**
- **配置步骤**：
  1. 将WiFi模块插入飞控的`TELEM`端口。
  2. 在QGC中通过UDP协议连接：
     - 设置`Target Host`为飞控WiFi模块的IP（如`192.168.1.1`）。
     - 端口通常为`14550`。
  3. 若使用协处理器（如机载电脑运行MAVROS），需修改`px4.launch`文件中的`gcs_url`为`udp://:14550@`。
- **特点**：短距离高速通信，支持视频传输。

---

### **3. 网络UDP连接**
#### **局域网内通信**
- **适用场景**：飞控通过协处理器（机载电脑）接入网络或PX4模拟器网络通信。
- **配置步骤**：
  1. **飞控/模拟器端**：
     - 启动PX4模拟器（模拟PX4硬件）时添加命令：`mavlink start -p -o 14550`（开放UDP端口）。
     - 或通过MAVROS广播：设置`gcs_url="udp-b://@"`，局域网内QGC自动连接。
      - `roslaunch mavros px4.launch fcu_url:="/dev/ttyACM0:57600" gcs_url:="udp-b://@"`
  2. **QGC端**：添加UDP连接，端口设为`14550`。
- **典型应用**：
  - **软件在环仿真（SITL）**：QGC连接同一局域网的PX4模拟器。
  - **多设备协同**：手机、平板等多终端同时监控飞控。

---

### **总结**
- **调试/烧录** → USB直连  
- **野外飞行** → 数传电台（SiK电台）  
- **室内/视频传输** → WiFi数传  
- **开发测试** → UDP网络（SITL/协处理器）
